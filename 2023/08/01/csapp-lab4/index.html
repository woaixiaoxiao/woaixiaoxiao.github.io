

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer">
  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Cao Dong">
  <meta name="keywords" content="">
  
    <meta name="description" content="概述 修改csim.c实现一个cache，make然后.&#x2F;test-csim测试是否正确 修改trans.c实现一个转置操作，并优化性能，测试方法如下123make &amp;&amp; .&#x2F;test-trans -M 32 -N 32   make &amp;&amp; .&#x2F;test-trans -M 64 -N 64  make &amp;&amp; .&#x2F;test-trans -M 61 -N">
<meta property="og:type" content="article">
<meta property="og:title" content="csapp_lab4">
<meta property="og:url" content="http://example.com/2023/08/01/csapp-lab4/index.html">
<meta property="og:site_name" content="dcao&#39;s blog">
<meta property="og:description" content="概述 修改csim.c实现一个cache，make然后.&#x2F;test-csim测试是否正确 修改trans.c实现一个转置操作，并优化性能，测试方法如下123make &amp;&amp; .&#x2F;test-trans -M 32 -N 32   make &amp;&amp; .&#x2F;test-trans -M 64 -N 64  make &amp;&amp; .&#x2F;test-trans -M 61 -N">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-01T12:27:02.000Z">
<meta property="article:modified_time" content="2023-12-24T12:27:57.871Z">
<meta property="article:author" content="Cao Dong">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>csapp_lab4 - dcao&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>CaoDong</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/scenery/p1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="csapp_lab4"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Cao Dong
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-01 20:27" pubdate>
          2023年8月1日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          39 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">csapp_lab4</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ol>
<li>修改<code>csim.c</code>实现一个cache，<code>make</code>然后<code>./test-csim</code>测试是否正确</li>
<li>修改<code>trans.c</code>实现一个转置操作，并优化性能，测试方法如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">make &amp;&amp; ./test-trans -M 32 -N 32   <br>make &amp;&amp; ./test-trans -M 64 -N 64  <br>make &amp;&amp; ./test-trans -M 61 -N 67 <br></code></pre></td></tr></table></figure></li>
</ol>
<h1 id="模拟cache"><a href="#模拟cache" class="headerlink" title="模拟cache"></a>模拟cache</h1><p>首先，这个实验就是要求我们能够得出在一系列操作之下，命中次数，不命中次数，淘汰页面的次数。</p>
<h2 id="cacheline的定义"><a href="#cacheline的定义" class="headerlink" title="cacheline的定义"></a>cacheline的定义</h2><p>这个模拟cache的功能非常简单，因为不需要我们真正的去读写数据，只需要模拟进出cache的情况就可以了。因此，我们每个cache行，只需要像下面这样定义即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">int</span> valid;<br>  <span class="hljs-type">int</span> tag;<br>  <span class="hljs-type">int</span> time_stamp;<br>&#125; cache_line;<br></code></pre></td></tr></table></figure>
<h2 id="cache的操作"><a href="#cache的操作" class="headerlink" title="cache的操作"></a>cache的操作</h2><p>然后我们需要支持三种操作，分别是load，store和modify</p>
<ol>
<li>load的意思很明显，就是先去cache中检查， 如果有这一行，那么就命中，如果不成功，那么就需要找出一个空行，或者根据lru找出一行来替换</li>
<li>store呢，其实在不考虑实际的写入写出的情况下，和load的操作一模一样，如果cache有这一行，那么就命中了，直接store进去，如果没有这一行，需要读入cache。那其实这个时候就没必要store回内存了，因为刚刚才从内存里读出来。我是感觉这里有点奇怪的。</li>
<li>modiy在实验文档里也说了，等于load+store</li>
</ol>
<p>综上所述，load和store的实现完全一样，modify相当于再操作一次。对应在代码里就是这样。<br>这个函数的第一行和第二行就是使用位运算取出了这个地址的set和tag</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Func</span><span class="hljs-params">(<span class="hljs-type">char</span> command, <span class="hljs-type">int</span> address, <span class="hljs-type">int</span> size)</span> &#123;<br>  <span class="hljs-type">int</span> set_num = (address &gt;&gt; b) &amp; ((<span class="hljs-number">1</span> &lt;&lt; s) - <span class="hljs-number">1</span>);<br>  <span class="hljs-type">int</span> tag = (address &gt;&gt; (b + s)) &amp; ((<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">32</span> - b - s)) - <span class="hljs-number">1</span>);<br>  FindCache(set_num, tag);<br>  <span class="hljs-keyword">if</span> (command == <span class="hljs-string">&#x27;M&#x27;</span>) &#123;<br>    FindCache(set_num, tag);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="关键的FindCache函数"><a href="#关键的FindCache函数" class="headerlink" title="关键的FindCache函数"></a>关键的FindCache函数</h2><p>通过这个函数可以发现，其实真正关键的函数是FindCache函数。<br>这个函数其实就是遍历这个对应的set的所有行</p>
<ol>
<li>如果命中了，则更新命中的次数，更新时间戳，然后直接返回</li>
<li>如果没命中，我们在遍历所有行的过程中需要记录是否存在空行，并且记录时间戳最小的行（LRU）。<ol>
<li>首先，更新miss的次数</li>
<li>如果存在空行，则将当前这一行写入空行，并更新valid，tag，和时间戳</li>
<li>如果不存在空间，则将当前这一行写入时间戳最小的行，并和2一样更新各种参数。这种情况还要额外更新一个淘汰页的数量<br>具体实现如下<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">FindCache</span><span class="hljs-params">(<span class="hljs-type">int</span> set_num, <span class="hljs-type">int</span> tag)</span> &#123;<br>  cache_line *cur_set = cache[set_num];<br>  <span class="hljs-type">int</span> empty_index = <span class="hljs-number">-1</span>;<br>  <span class="hljs-type">int</span> min_ts_line_index = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; E; i++) &#123;<br>    <span class="hljs-comment">// 当前行存在于cache中，即valid=1，并且tag相同</span><br>    <span class="hljs-keyword">if</span> (cur_set[i].valid == <span class="hljs-number">1</span> &amp;&amp; cur_set[i].tag == tag) &#123;<br>      hit_count++;<br>      <span class="hljs-comment">// 记得更新时间戳</span><br>      cur_set[i].time_stamp = time_stamp++;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 如果存在空行，即valid=0；</span><br>    <span class="hljs-keyword">if</span> (cur_set[i].valid == <span class="hljs-number">0</span>) &#123;<br>      empty_index = i;<br>    &#125;<br>    <span class="hljs-comment">// 记录时间戳最小的，实在不行就要去替换了</span><br>    <span class="hljs-keyword">if</span> (cur_set[i].time_stamp &lt; cur_set[min_ts_line_index].time_stamp) &#123;<br>      min_ts_line_index = i;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 如果没有命中，那么就发生了miss</span><br>  miss_count++;<br>  <span class="hljs-comment">// 载入某一行，如果有空行，就载入空行</span><br>  <span class="hljs-comment">// 如果没有空行，则载入时间戳最小的，这就发生了evict</span><br>  <span class="hljs-keyword">if</span> (empty_index != <span class="hljs-number">-1</span>) &#123;<br>    LoadOrEvict(cur_set, empty_index, tag);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    LoadOrEvict(cur_set, min_ts_line_index, tag);<br>    eviction_count++;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h2 id="整体代码结构"><a href="#整体代码结构" class="headerlink" title="整体代码结构"></a>整体代码结构</h2><p>这个实验的关键部分就这么多。剩下的有点类似于脏活累活，但是也很有意义。先看一下整体的代码结构<br>可以分为以下几个部分</p>
<ol>
<li>解析命令行参数</li>
<li>根据解析出来的参数初始化我们的cache</li>
<li>读取文件里的操作，并进行操作</li>
<li>输出结果</li>
<li>释放申请的变量<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-comment">// 解析命令行参数</span><br>  <span class="hljs-type">int</span> par_res = parser(argc, argv);<br>  <span class="hljs-keyword">if</span> (par_res == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-comment">// 创造cache，初始化cache</span><br>  Init();<br>  <span class="hljs-comment">// 读取文件，获得操作，进行操作</span><br>  <span class="hljs-type">int</span> get_res = GetOperation();<br>  <span class="hljs-keyword">if</span> (get_res == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-comment">// 输出结果</span><br>  printSummary(hit_count, miss_count, eviction_count);<br>  <span class="hljs-comment">// 释放malloc申请的变量</span><br>  Destory();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="命令行参数解析部分"><a href="#命令行参数解析部分" class="headerlink" title="命令行参数解析部分"></a>命令行参数解析部分</h2><p>首先是我们通过命令行启动程序，那么我们的参数都是在命令行中给出的，如何解析命令行的参数呢？需要使用<code>getopt</code>函数。<br>这个函数的三个参数</p>
<ol>
<li>程序参数的数量</li>
<li>argv可以理解为一个二维数组，如果我们的输入是这样的<code>./my_program -f input.txt -o output.txt</code>，那么argv的实际参数是这样的<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">argv[<span class="hljs-number">0</span>] -&gt; <span class="hljs-string">&quot;./my_program&quot;</span><br>argv[<span class="hljs-number">1</span>] -&gt; <span class="hljs-string">&quot;-f&quot;</span><br>argv[<span class="hljs-number">2</span>] -&gt; <span class="hljs-string">&quot;input.txt&quot;</span><br>argv[<span class="hljs-number">3</span>] -&gt; <span class="hljs-string">&quot;-o&quot;</span><br>argv[<span class="hljs-number">4</span>] -&gt; <span class="hljs-string">&quot;output.txt&quot;</span><br></code></pre></td></tr></table></figure></li>
<li>第三个参数是我们参数的format，如果是这样的”hvs:E:b:t:”，那就说明我们有hvsEbt这六种参数，并且后面跟着冒号的说明这些参数还有值<br>这个函数的返回值，这里用opt记录，就是读取到的参数。<br>最后还有一个变量叫optrag，这个需要我们声明，只要我们正确声明了getopt函数的头文件，这个变量就存在了。代表了当前参数对应的值。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">parser</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-comment">// 解析参数</span><br>  <span class="hljs-type">int</span> opt;<br>  <span class="hljs-keyword">while</span> ((opt = getopt(argc, argv, <span class="hljs-string">&quot;hvs:E:b:t:&quot;</span>)) != <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">switch</span> (opt) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;h&#x27;</span>:<br>      h_flag = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>:<br>      v_flag = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>:<br>      s = atoi(optarg);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;E&#x27;</span>:<br>      E = atoi(optarg);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>:<br>      b = atoi(optarg);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;t&#x27;</span>:<br>      tracefile = optarg;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;?&#x27;</span>:<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;未知选项或缺少参数\n&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="初始化cache部分"><a href="#初始化cache部分" class="headerlink" title="初始化cache部分"></a>初始化cache部分</h2><p>首先，我们的cache的定义是这样的<code>cacheline ** cache</code>，因此要用二维数组的方式对这个cache进行初始化。<br>先分配出S个行，然后给每行分配出E列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Init</span><span class="hljs-params">()</span> &#123;<br>  S = <span class="hljs-number">1</span> &lt;&lt; s;<br>  cache = (cache_line **)<span class="hljs-built_in">malloc</span>(S * <span class="hljs-keyword">sizeof</span>(cache_line *));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; S; i++) &#123;<br>    cache[i] = (cache_line *)<span class="hljs-built_in">malloc</span>(E * <span class="hljs-keyword">sizeof</span>(cache_line));<br>    <span class="hljs-comment">// 记得初始化每一行的tag为0</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; E; j++) &#123;<br>      cache[i][j].tag = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="读取文件的操作"><a href="#读取文件的操作" class="headerlink" title="读取文件的操作"></a>读取文件的操作</h2><p>首先，我们读取进来的tracefile其实只是一个文件名，还需要根据这个文件名去真正的取到这个文件<br>这就要使用这个了<code>FILE *file_ptr;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">GetOperation</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">// 读取文件，获得访问记录</span><br>  file_ptr = fopen(tracefile, <span class="hljs-string">&quot;r&quot;</span>);<br>  <span class="hljs-keyword">if</span> (file_ptr == <span class="hljs-literal">NULL</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;无法打开文件 %s\n&quot;</span>, tracefile);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-type">char</span> buffer[<span class="hljs-number">100</span>];<br>  <span class="hljs-type">char</span> command;<br>  <span class="hljs-type">int</span> address;<br>  <span class="hljs-type">int</span> size;<br>  <span class="hljs-keyword">while</span> (fgets(buffer, <span class="hljs-keyword">sizeof</span>(buffer), file_ptr)) &#123;<br>    <span class="hljs-keyword">if</span> (buffer[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;I&#x27;</span>) &#123;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buffer, <span class="hljs-string">&quot; %c %x,%d&quot;</span>, &amp;command, &amp;address, &amp;size) == <span class="hljs-number">3</span>) &#123;<br>      <span class="hljs-comment">// 成功获取操作</span><br>      Func(command, address, size);<br>      <span class="hljs-comment">// printf(&quot;%c %x,%d\n&quot;, command, address, size);</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 输入不合法</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>  &#125;<br>  fclose(file_ptr);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="释放内存的操作"><a href="#释放内存的操作" class="headerlink" title="释放内存的操作"></a>释放内存的操作</h2><p>申请了多少就释放多少，先释放列，再释放行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Destory</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; S; i++) &#123;<br>    <span class="hljs-built_in">free</span>(cache[i]);<br>  &#125;<br>  <span class="hljs-built_in">free</span>(cache);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>整体来说，这个实验并不难。因为根本没用到什么难的算法，暴力遍历就完事了。<br>但是因为前前后后所有内容都需要自己实验，还是有不少dirtywork的，这可能比较像真正工作上写的代码，而不是算法题的代码</p>
<h1 id="cache转置"><a href="#cache转置" class="headerlink" title="cache转置"></a>cache转置</h1><p>给我们的cache配置是<code>s = 5, E = 1, b = 5</code><br>即有32个set，每个set有一行，即直接映射，每一行可以存储32字节，即每个set可以存储8个整数</p>
<h2 id="32×32"><a href="#32×32" class="headerlink" title="32×32"></a>32×32</h2><p>首先，我们要做的是尽量减少miss，即让我们的cache尽可能的去命中。<br>那么如果直接按照一行一行的操作，会有什么问题呢？</p>
<ol>
<li>对于A，问题倒还好，只要B不会干扰到它的行，那么A的命中率就是7&#x2F;8</li>
<li>但是对于B呢？B是按列来访问的，极有可能cache命中的次数为0<br>那么分块又是为什么可以优化呢？<br>因为分块的情况下，加入是按4×4的大小分块，那么我们最多使用B的某4列，那么B的命中率很有可能达到3&#x2F;4，为什么说是很可能呢，因为A和B之间可能也会有点干扰，但是这总比之前很可能命中率为0好。<br>综上所述，通过分块是有可能有效降低cache miss的次数的，现在就要研究到底怎么分块了。<br>32×32代表的是每行每列都是32个整数，可以去看<a target="_blank" rel="noopener" href="https://wdxtub.com/csapp/thick-csapp-lab-4/2016/04/16/">这位大佬的图</a><br>可以发现，如果通过8×8的分块方式，这个8×8的小块内部是不会冲突的</li>
<li>这个不冲突对于A来说其实没啥用，因为A本来就是按行来访问的</li>
<li>但是对B来说，这就很重要了，因为B是按列来访问的，如果这个小块内部冲突，那B就会不断的替换cache<br>由此可以写出下面这个代码。但是可以发现这个代码拿不到满分，因为满分要求300次miss以内，而这个代码是343<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">transpose_submit</span><span class="hljs-params">(<span class="hljs-type">int</span> M, <span class="hljs-type">int</span> N, <span class="hljs-type">int</span> A[N][M], <span class="hljs-type">int</span> B[M][N])</span> &#123;<br>  <span class="hljs-comment">// i和j枚举出了每个8×8的矩阵的左顶点</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i += <span class="hljs-number">8</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">32</span>; j += <span class="hljs-number">8</span>) &#123;<br>      <span class="hljs-comment">// cnti和cntj则分别枚举这个小矩阵的行和列</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> cnti = <span class="hljs-number">0</span>; cnti &lt; <span class="hljs-number">8</span>; cnti++) &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> cntj=<span class="hljs-number">0</span>;cntj&lt;<span class="hljs-number">8</span>;cntj++)&#123;<br>            B[j+cntj][i+cnti]=A[i+cnti][j+cntj];<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
为什么呢？因为，A和B之间存在打架的情况。通过打印地址是可以发现A和B的距离很尴尬，使得A和B的任意一个cacheline都是映射到同一个cache。</li>
<li>其实这也没太大关系，因为我们在A和B中取的8×8的块并不是相同位置，而是根据对角线对称之后的位置，这是没关系的，因为根据上面那位大佬博客里的图可以发现，对称之后其实A和B就不会撞车。</li>
<li>但是，在对角线的时候，就会出现问题，这时候A和B会撞车。那么该如何优化呢？</li>
</ol>
<p>可以通过csapp第五章介绍的循环展开的方式来优化，我们可以提前把A的这一行的八个int给取出来，这会将它放到寄存器里，然后我们再去修改B，这时候就不会撞车了。具体实现如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">transpose_submit</span><span class="hljs-params">(<span class="hljs-type">int</span> M, <span class="hljs-type">int</span> N, <span class="hljs-type">int</span> A[N][M], <span class="hljs-type">int</span> B[M][N])</span> &#123;<br>  <span class="hljs-comment">// i和j枚举出了每个8×8的矩阵的左顶点</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i += <span class="hljs-number">8</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">32</span>; j += <span class="hljs-number">8</span>) &#123;<br>      <span class="hljs-comment">// cnt枚举的是小矩阵的行数</span><br>      <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> cnt=<span class="hljs-number">0</span>;cnt&lt;<span class="hljs-number">8</span>;cnt++)&#123;<br>        <span class="hljs-type">int</span> temp1 = A[i + cnt][j];<br>        <span class="hljs-type">int</span> temp2 = A[i + cnt][j + <span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span> temp3 = A[i + cnt][j + <span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> temp4 = A[i + cnt][j + <span class="hljs-number">3</span>];<br>        <span class="hljs-type">int</span> temp5 = A[i + cnt][j + <span class="hljs-number">4</span>];<br>        <span class="hljs-type">int</span> temp6 = A[i + cnt][j + <span class="hljs-number">5</span>];<br>        <span class="hljs-type">int</span> temp7 = A[i + cnt][j + <span class="hljs-number">6</span>];<br>        <span class="hljs-type">int</span> temp8 = A[i + cnt][j + <span class="hljs-number">7</span>];<br><br>        B[j][i + cnt] = temp1;<br>        B[j + <span class="hljs-number">1</span>][i + cnt] = temp2;<br>        B[j + <span class="hljs-number">2</span>][i + cnt] = temp3;<br>        B[j + <span class="hljs-number">3</span>][i + cnt] = temp4;<br>        B[j + <span class="hljs-number">4</span>][i + cnt] = temp5;<br>        B[j + <span class="hljs-number">5</span>][i + cnt] = temp6;<br>        B[j + <span class="hljs-number">6</span>][i + cnt] = temp7;<br>        B[j + <span class="hljs-number">7</span>][i + cnt] = temp8;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>总结来说</p>
<ol>
<li>避免自己跟自己冲突，因此选择8×8，而不是9×9或以上</li>
<li>避免别人和自己冲突，这里采用了让寄存器来帮忙的方法</li>
</ol>
<h2 id="64×64"><a href="#64×64" class="headerlink" title="64×64"></a>64×64</h2><p>64×64就不能直接用8×8了，同样可以先看上面那位大佬的博客画的，使用8乘8的矩阵，自己就和自己冲突了。<br>而如果使用4×4的，小矩阵内部倒不会冲突，但是因为每次取8个，结果只用了4个，后面还得再取一次，又要碰撞一次。<br>所以，8×8地访问还是最适合的，因为不会出现二次访问的需求。但是如果直接使用8×8的方式，又会导致自己不断地撞自己。<br>那综合一下上面的问题，</p>
<ol>
<li>主要就是我们每次取一个cacheline，这个cacheline都包括了8个数字</li>
<li>但是我们如果用4×4的小矩阵去处理，就会导致同一行需要取两次</li>
<li>而如果直接使用8×8去取，会导致列操作的那个矩阵不断地撞自己。</li>
</ol>
<p>有一些大佬就提出了一种方法，我们以8×8的小矩阵去取数据，然后将它分成4个4×4的小矩阵</p>
<ol start="4">
<li>当我们处理A的左上小矩阵时，需要将它放到B的左上小矩阵，这时候我们的cache里有A的4个cache行，B的4个cache行（不在对角线的情况下）</li>
<li>正常情况下，我们会去操作A的右上小矩阵，将它放到B的左下小矩阵。注意，在这个时候，我们操作A的右上小矩阵是不会发生cache miss的，因为A的前4个cache行就在cache中。但是如果我们访问B的左下小矩阵，那就出问题了。因为B的下4个cache行和B的上4个cache行冲突了。</li>
<li>但是如果我们不正常，我们把A的右上小矩阵，存到B的右上小矩阵中，那就不会发生额外的碰撞了。因为只涉及了A和B的前4个cache行。</li>
</ol>
<p>那么如果操作到这里，A的前4个cache行已经全部用完了，后面不会再访问了，并且除去对角线情况，命中率应该是7&#x2F;8</p>
<p>接下来，我们操作A的左下矩阵，将其放到B的右上矩阵。而B的右上矩阵暂存了A的右上矩阵，这个矩阵应该是放到B的左下矩阵的。所以接下来的这一波操作是关键。</p>
<ol start="7">
<li>首先，我们按列取出A的左下矩阵，然后按行取出B的右上矩阵</li>
<li>接下来，将B的右上矩阵置为A的左下矩阵，然后将B的左下矩阵置为取出的B的右上矩阵<br>这里有个细节，就在于我们是按行取出B的右上矩阵的。为什么说它细节呢？</li>
<li>首先，我们进行到这个阶段的时候，cache中有B的前4行cacheline。</li>
<li>而我们这个阶段需要修改B的左下矩阵，这就涉及到了B的下4行。</li>
<li>如果我们在这个阶段按行操作B<ol>
<li>那么取出B的右上矩阵的某一行（这一行存的其实是B的左下矩阵的值，如果不清楚，回去看看第一波操作）</li>
<li>然后我们再紧接着将这一行修改为正确的值，</li>
</ol>
</li>
<li>至此，B的这一行将永远不再需要被访问。然后它就会被下4行中对应的那一个给替换掉。<br>而如果是按列取出B的右上矩阵呢？那就不断地碰撞，miss。</li>
</ol>
<p>最后一波操作，就是把A的右下矩阵给放到B的右下矩阵中去，这就很轻松了，基本不会miss。<br>代码实现如下，这个操作说起来还是很抽象的，对着代码看，更加清楚。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">deal_64_64</span><span class="hljs-params">(<span class="hljs-type">int</span> M, <span class="hljs-type">int</span> N, <span class="hljs-type">int</span> A[N][M], <span class="hljs-type">int</span> B[M][N])</span> &#123;<br>  <span class="hljs-comment">// i和j枚举出了每个8×8的矩阵的左顶点</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; i += <span class="hljs-number">8</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">64</span>; j += <span class="hljs-number">8</span>) &#123;<br>      <span class="hljs-type">int</span> temp1, temp2, temp3, temp4, temp5, temp6, temp7, temp8;<br>      <span class="hljs-type">int</span> cnti, cntj;<br>      <span class="hljs-comment">// 现在处理A的左上4×4，顺便操作一下A的右上4×4</span><br>      <span class="hljs-keyword">for</span> (cnti = <span class="hljs-number">0</span>; cnti &lt; <span class="hljs-number">4</span>; cnti++) &#123;<br>        <span class="hljs-comment">// 取出A的左上，以行的方式</span><br>        temp1 = A[i + cnti][j];<br>        temp2 = A[i + cnti][j + <span class="hljs-number">1</span>];<br>        temp3 = A[i + cnti][j + <span class="hljs-number">2</span>];<br>        temp4 = A[i + cnti][j + <span class="hljs-number">3</span>];<br>        <span class="hljs-comment">// 取出A的右上，以行的方式</span><br>        temp5 = A[i + cnti][j + <span class="hljs-number">4</span>];<br>        temp6 = A[i + cnti][j + <span class="hljs-number">5</span>];<br>        temp7 = A[i + cnti][j + <span class="hljs-number">6</span>];<br>        temp8 = A[i + cnti][j + <span class="hljs-number">7</span>];<br>        <span class="hljs-comment">// 将A的左上放到正确的地方，以列的方式</span><br>        B[j][i + cnti] = temp1;<br>        B[j + <span class="hljs-number">1</span>][i + cnti] = temp2;<br>        B[j + <span class="hljs-number">2</span>][i + cnti] = temp3;<br>        B[j + <span class="hljs-number">3</span>][i + cnti] = temp4;<br>        <span class="hljs-comment">// 将A的右上放到现在B的右上，提前处理一下，省的后面还要访问A的这个cacheline</span><br>        B[j][i + cnti + <span class="hljs-number">4</span>] = temp5;<br>        B[j + <span class="hljs-number">1</span>][i + cnti + <span class="hljs-number">4</span>] = temp6;<br>        B[j + <span class="hljs-number">2</span>][i + cnti + <span class="hljs-number">4</span>] = temp7;<br>        B[j + <span class="hljs-number">3</span>][i + cnti + <span class="hljs-number">4</span>] = temp8;<br>      &#125;<br>      <span class="hljs-comment">// 至此，A的前4行已经全部处理完了，命中率约为7/8</span><br>      <span class="hljs-comment">// 上述操作处理完之后，B的前4行都在cache中</span><br>      <span class="hljs-comment">// 现在处理A的左下，将其移到B的右上，同时我们已经把A的右上存在了B的右上</span><br>      <span class="hljs-comment">// 所以要记得取下来，放到B的左下去</span><br>      <span class="hljs-keyword">for</span> (cntj = <span class="hljs-number">0</span>; cntj &lt; <span class="hljs-number">4</span>; cntj++) &#123;<br>        <span class="hljs-comment">// 取出A的左下，一列一列地取</span><br>        temp1 = A[i + <span class="hljs-number">4</span>][j + cntj];<br>        temp2 = A[i + <span class="hljs-number">5</span>][j + cntj];<br>        temp3 = A[i + <span class="hljs-number">6</span>][j + cntj];<br>        temp4 = A[i + <span class="hljs-number">7</span>][j + cntj];<br>        <span class="hljs-comment">// 取出当前B的右上，一行一行地取，之后还要一行一行地放到B的左下</span><br>        temp5 = B[j + cntj][i + <span class="hljs-number">4</span>];<br>        temp6 = B[j + cntj][i + <span class="hljs-number">5</span>];<br>        temp7 = B[j + cntj][i + <span class="hljs-number">6</span>];<br>        temp8 = B[j + cntj][i + <span class="hljs-number">7</span>];<br>        <span class="hljs-comment">// 修改B的右上为真正的值，即A的左下</span><br>        B[j + cntj][i + <span class="hljs-number">4</span>] = temp1;<br>        B[j + cntj][i + <span class="hljs-number">5</span>] = temp2;<br>        B[j + cntj][i + <span class="hljs-number">6</span>] = temp3;<br>        B[j + cntj][i + <span class="hljs-number">7</span>] = temp4;<br>        <span class="hljs-comment">// 至此B的这一行完全OK了，虽然马上就要被自己干掉，但是也没关系，反正也用不上了</span><br>        <span class="hljs-comment">// 接下来别忘了修改B的左下，本来应该是A的右上，但是我们提前存在了B的右上</span><br>        <span class="hljs-comment">// 现在就是temp5-8</span><br>        B[j + cntj + <span class="hljs-number">4</span>][i] = temp5;<br>        B[j + cntj + <span class="hljs-number">4</span>][i + <span class="hljs-number">1</span>] = temp6;<br>        B[j + cntj + <span class="hljs-number">4</span>][i + <span class="hljs-number">2</span>] = temp7;<br>        B[j + cntj + <span class="hljs-number">4</span>][i + <span class="hljs-number">3</span>] = temp8;<br>      &#125;<br>      <span class="hljs-comment">// 最后修改B的右下</span><br>      <span class="hljs-keyword">for</span> (cnti = <span class="hljs-number">4</span>; cnti &lt; <span class="hljs-number">8</span>; cnti++) &#123;<br>        temp1 = A[i + cnti][j + <span class="hljs-number">4</span>];<br>        temp2 = A[i + cnti][j + <span class="hljs-number">5</span>];<br>        temp3 = A[i + cnti][j + <span class="hljs-number">6</span>];<br>        temp4 = A[i + cnti][j + <span class="hljs-number">7</span>];<br>        B[j + <span class="hljs-number">4</span>][i + cnti] = temp1;<br>        B[j + <span class="hljs-number">5</span>][i + cnti] = temp2;<br>        B[j + <span class="hljs-number">6</span>][i + cnti] = temp3;<br>        B[j + <span class="hljs-number">7</span>][i + cnti] = temp4;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="61×67"><a href="#61×67" class="headerlink" title="61×67"></a>61×67</h2><p>这玩意就很不规则了，之前之所以又是循环展开的，又是小心翼翼控制矩阵大小的，无非是因为</p>
<ol>
<li>循环展开：避免A和B之间碰撞。因为A和B的地址间距刚好是cache大小的倍数。</li>
<li>矩阵大小：避免A或者B内部不断碰撞。行操作的那一个没事，但是列操作的那一个就遭殃了。</li>
</ol>
<p>而这一切在61×64的矩阵下都不是问题，因为A或者B内部基本不会碰撞，那矩阵的大小就无所谓了，选一个最小的就行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> edge 17</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">deal_61_67</span><span class="hljs-params">(<span class="hljs-type">int</span> M, <span class="hljs-type">int</span> N, <span class="hljs-type">int</span> A[N][M], <span class="hljs-type">int</span> B[M][N])</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += edge) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; M; j += edge) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = i; x &lt; i + edge &amp;&amp; x &lt; N; x++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = j; y &lt; j + edge &amp;&amp; y &lt; M; y++) &#123;<br>          B[y][x] = A[x][y];<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>感谢<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/456858668#">这位大佬</a>的博客提供的帮助</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CSAPP/" class="category-chain-item">CSAPP</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CSAPP/" class="print-no-link">#CSAPP</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>csapp_lab4</div>
      <div>http://example.com/2023/08/01/csapp-lab4/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Cao Dong</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/08/03/csapp-lab5/" title="csapp_lab5">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">csapp_lab5</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/30/csapp-lab3/" title="csapp_lab3">
                        <span class="hidden-mobile">csapp_lab3</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
